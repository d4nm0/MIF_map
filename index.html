<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>France Fabrique</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    <style>
        #map {
            height: 95vh;
        }
        .popup-content {
            text-align: center;
        }
        .popup-content img {
            width: 100%;
            max-width: 200px;
            height: auto;
            margin-bottom: 10px;
        }
        .popup-content h3 {
            margin: 0 0 10px;
        }
        .popup-content p {
            margin: 0 0 10px;
        }
        .popup-content a {
            color: #007BFF;
            text-decoration: none;
        }
        .popup-content a:hover {
            text-decoration: underline;
        }
        .marker-icon img {
            width: 100%;
            height: auto;
            object-fit: contain;
        }
    </style>
</head>
<body>
    <header style="text-align: center; font-family: fantasy; text-transform: uppercase;">france fabrique.fr</header>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
    <script type="module">
        // Importer le SDK de Supabase
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        // import { SUPABASE_URL, SUPABASE_KEY } from './config.js'; 
        const supabase = createClient(process.env.SUPABASE_URL, process.env.SUPABASE_KEY);

        const map = L.map('map').setView([46.603354, 1.888334], 6);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 18,
        }).addTo(map);

        const markers = L.markerClusterGroup();

        // Définir des icônes pour chaque type
        const iconMap = {
            usi: L.icon({
                iconUrl: 'usi.png',
                iconSize: [20, 32],
                iconAnchor: [16, 32],
                popupAnchor: [0, -32],
                className: 'marker-icon'
            }),
            mag: L.icon({
                iconUrl: 'mif.png',
                iconSize: [32, 32],
                iconAnchor: [16, 32],
                popupAnchor: [0, -32],
                className: 'marker-icon'
            })
        };

        async function fetchData() {
            // Récupérer les données depuis Supabase
            const { data, error } = await supabase
                .from('Marker') // Remplacez par le nom de votre table
                .select('*'); // Sélectionner toutes les colonnes

            if (error) {
                console.error('Erreur lors de la récupération des données :', error);
                return;
            }

            console.log(data)
            // Ajouter les marqueurs à la carte
            data.forEach(point => {
                const markerIcon = iconMap[point.type] || L.icon({
                    iconUrl: 'marker.png',
                    iconSize: [32, 32],
                    iconAnchor: [16, 32],
                    popupAnchor: [0, -32],
                    className: 'marker-icon'
                });

                const marker = L.marker([point.lat, point.lng], { icon: markerIcon });

                const popupContent = `
                    <div class="popup-content">
                        <img src="${point.image}" alt="${point.title}" />
                        <h3>${point.title}</h3>
                        <p>${point.description}</p>
                        <a href="${point.link}" target="_blank">En savoir plus</a>
                    </div>
                `;

                marker.bindPopup(popupContent);
                markers.addLayer(marker);
            });

            map.addLayer(markers);
        }

        // Appeler la fonction de récupération des données
        fetchData();
    </script>
</body>
</html>
